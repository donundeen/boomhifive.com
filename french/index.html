<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Learning Flashcards</title>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=zPY6ttoC"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .nav-menu {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 0;
            text-align: center;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 25px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .nav-menu a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-menu a.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        button:hover {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        /* Hamburger menu styles */
        .hamburger-menu {
            display: none;
            position: relative;
        }

        .hamburger-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hamburger-btn:hover {
            background: #3a8bfe;
        }

        .menu-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 15px;
        }

        .menu-content.show {
            display: block;
        }

        .menu-control-group {
            margin-bottom: 15px;
        }

        .menu-control-group:last-child {
            margin-bottom: 0;
        }

        .menu-control-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .menu-control-group select {
            width: 100%;
        }

        .menu-control-group button {
            width: 100%;
        }

        /* Action buttons layout */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .correct-incorrect-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }

        .correct-btn, .incorrect-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .correct-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .correct-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .incorrect-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .incorrect-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #b21e2b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        /* Speak buttons layout */
        .speak-buttons {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }

        .speak-btn {
            flex: 1;
            padding: 12px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            border: none;
            cursor: pointer;
            text-align: center;
        }

        .speak-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }

        .speak-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
        }

        .speak-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
        }

        .stat {
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.8em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .flashcard-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .card-legend {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border: 1px solid #e9ecef;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #495057;
        }

        .legend-key {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: bold;
            color: #495057;
            font-size: 0.8em;
            min-width: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .legend-key:hover {
            background: #e9ecef;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .legend-key:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .flashcard {
            width: 100%;
            max-width: 600px;
            height: 350px;
            perspective: 1000px;
            cursor: pointer;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .flashcard.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .word {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .example {
            font-size: 1.2em;
            line-height: 1.6;
            opacity: 0.9;
            max-width: 90%;
        }

        .grammar-info {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 10px;
            font-style: italic;
            max-width: 90%;
        }

        .learn-more-container {
            margin-top: 20px;
            text-align: center;
        }

        .learn-more-link {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .learn-more-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
            background: linear-gradient(135deg, #3a8bfe 0%, #00d4fe 100%);
        }

        .learn-more-link:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(79, 172, 254, 0.3);
        }

        .speak-btn {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            border: none;
            cursor: pointer;
            margin-right: 15px;
        }

        .speak-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
        }

        .speak-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
        }

        .speak-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }



        .no-cards {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.2em;
        }

        .no-cards h2 {
            margin-bottom: 20px;
            color: #495057;
        }

        .reset-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                padding: 15px;
            }
            
            .control-group {
                display: none;
            }
            
            .hamburger-menu {
                display: block;
            }
            
            .flashcard-container {
                padding: 20px;
            }
            
            .card-legend {
                display: none;
            }
            
            .word {
                font-size: 2em;
            }
            
            .example {
                font-size: 1em;
            }
            
            .grammar-info {
                font-size: 0.8em;
            }
            
            .learn-more-link {
                padding: 8px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-menu">
            <a href="index.html" class="active">📚 Flashcards</a>
            <a href="taboo.html">🎯 Taboo Game</a>
        </div>
        
        <div class="header">
            <h1>🇫🇷 French Learning Flashcards</h1>
        </div>

        <div class="controls">
            <!-- Desktop controls -->
            <div class="control-group">
                <label for="fileSelect">Select Category:</label>
                <select id="fileSelect">
                    <option value="">Choose a category...</option>
                    <option value="french_nouns.json">Nouns</option>
                    <option value="french_adjectives.json">Adjectives</option>
                    <option value="french_adverbs.json">Adverbs</option>
                    <option value="french_connecting_words.json">Connecting Words</option>
                    <option value="french_prepositions.json">Prepositions</option>
                    <option value="french_irregular_verbs.json">Irregular Verbs</option>
                    <option value="french_verbs.json">Verbs</option>
                    <option value="french_versatile_words.json">Versatile Words</option>
                    <option value="prepositions_with_verbs.json">Prepositions with Verbs</option>
                    <option value="the_v_verbs.json">V Verbs (Aller, Vouloir, Voir, Avoir)</option>
                    <option value="tefaq_vocab_final.json">TEFaQ Vocabulary</option>
                    <option value="phrases_for_learning.json">Learning Phrases</option>
                    <option value="asking_questions.json">Asking Questions (TEFaQ Part A)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="sideSelect">Show First:</label>
                <select id="sideSelect">
                    <option value="french">French</option>
                    <option value="english">English</option>
                    <option value="random">Random</option>
                </select>
                <button id="resetScoreBtn" class="reset-btn">Reset Score</button>
            </div>

            <!-- Mobile hamburger menu -->
            <div class="hamburger-menu">
                <button class="hamburger-btn" id="hamburgerBtn">
                    ☰ Menu
                </button>
                <div class="menu-content" id="menuContent">
                    <div class="menu-control-group">
                        <label for="fileSelectMobile">Select Category:</label>
                        <select id="fileSelectMobile">
                            <option value="">Choose a category...</option>
                            <option value="french_nouns.json">Nouns</option>
                            <option value="french_adjectives.json">Adjectives</option>
                            <option value="french_adverbs.json">Adverbs</option>
                            <option value="french_connecting_words.json">Connecting Words</option>
                            <option value="french_prepositions.json">Prepositions</option>
                            <option value="french_irregular_verbs.json">Irregular Verbs</option>
                            <option value="french_verbs.json">Verbs</option>
                            <option value="french_versatile_words.json">Versatile Words</option>
                            <option value="prepositions_with_verbs.json">Prepositions with Verbs</option>
                            <option value="the_v_verbs.json">V Verbs (Aller, Vouloir, Voir, Avoir)</option>
                            <option value="tefaq_vocab_final.json">TEFaQ Vocabulary</option>
                            <option value="phrases_for_learning.json">Learning Phrases</option>
                            <option value="asking_questions.json">Asking Questions (TEFaQ Part A)</option>
                        </select>
                    </div>
                    <div class="menu-control-group">
                        <label for="sideSelectMobile">Show First:</label>
                        <select id="sideSelectMobile">
                            <option value="french">French</option>
                            <option value="english">English</option>
                            <option value="random">Random</option>
                        </select>
                    </div>
                    <div class="menu-control-group">
                        <button id="resetScoreBtnMobile" class="reset-btn">Reset Score</button>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="totalCards">0</div>
                    <div class="stat-label">Total Cards</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="remainingCards">0</div>
                    <div class="stat-label">Remaining</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="correctCards">0</div>
                    <div class="stat-label">Correct</div>
                </div>
            </div>
        </div>

        <div class="flashcard-container">
            <!-- Desktop legend -->
            <div class="card-legend">
                <div class="legend-item">
                    <span class="legend-key" data-action="previous">←</span>
                    <span>Previous</span>
                </div>
                <div class="legend-item">
                    <span class="legend-key" data-action="next">→</span>
                    <span>Next</span>
                </div>
                <div class="legend-item">
                    <span class="legend-key" data-action="flip">Space</span>
                    <span>Flip</span>
                </div>
                <div class="legend-item">
                    <span class="legend-key" data-action="correct">A</span>
                    <span>Correct</span>
                </div>
                <div class="legend-item">
                    <span class="legend-key" data-action="incorrect">X</span>
                    <span>Incorrect</span>
                </div>
                <div class="legend-item">
                    <span class="legend-key" data-action="speak">S</span>
                    <span>Speak</span>
                </div>
            </div>

            <!-- Mobile action buttons -->
            <div class="action-buttons">
                <div class="navigation-buttons">
                    <button id="previousBtn" class="nav-btn">← Previous</button>
                    <button id="nextBtn" class="nav-btn">Next →</button>
                </div>
                <div class="correct-incorrect-buttons">
                    <button id="correctBtn" class="correct-btn">✓ Correct</button>
                    <button id="incorrectBtn" class="incorrect-btn">✗ Incorrect</button>
                </div>
            </div>

            <div id="flashcard" class="flashcard">
                <div class="card-inner">
                    <div class="card-front">
                        <div class="word" id="frontWord">Select a category to start</div>
                        <div class="example" id="frontExample"></div>
                        <div class="grammar-info" id="frontGrammarInfo"></div>
                    </div>
                    <div class="card-back">
                        <div class="word" id="backWord"></div>
                        <div class="example" id="backExample"></div>
                        <div class="grammar-info" id="backGrammarInfo"></div>
                    </div>
                </div>
            </div>
            
            <div class="learn-more-container">
                <div class="speak-buttons">
                    <button id="speakBtn" class="speak-btn">🔊 Speak French</button>
                    <button id="speakEnglishBtn" class="speak-btn">🔊 Speak English</button>
                </div>
                <button id="forceStopBtn" class="speak-btn" style="display: none; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">⏹️ Force Stop</button>
                <button id="hideTextBtn" class="speak-btn">👁️ Hide Text</button>
                <button id="showTextBtn" class="speak-btn" style="display: none;">👁️ Show Text</button>
                <a href="#" id="learnMoreLink" target="_blank" class="learn-more-link">Learn More</a>
            </div>
        </div>


    </div>

    <script>
      let FRENCH_NOUNS_DATA = [];
      let FRENCH_ADJECTIVES_DATA = [];
      let FRENCH_ADVERBS_DATA = [];
      let FRENCH_CONNECTING_WORDS_DATA = [];
      let FRENCH_PREPOSITIONS_DATA = [];
      let FRENCH_IRREGULAR_VERBS_DATA = [];
      let FRENCH_VERBS_DATA = [];
      let FRENCH_VERSATILE_WORDS_DATA = [];
      let THE_V_VERBS_DATA = [];
      let TEFAQ_VOCAB_FINAL_DATA = [];
      let PHRASES_FOR_LEARNING_DATA = [];
      // get from json file
      fetch('french_nouns.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_NOUNS_DATA = data;
        });

      fetch('french_adjectives.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_ADJECTIVES_DATA = data;
        });

      fetch('french_adverbs.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_ADVERBS_DATA = data;
        });

      fetch('french_connecting_words.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_CONNECTING_WORDS_DATA = data;
        });

      fetch('french_prepositions.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_PREPOSITIONS_DATA = data;
        });

      fetch('french_irregular_verbs.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_IRREGULAR_VERBS_DATA = data;
        });

      fetch('french_verbs.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_VERBS_DATA = data;
        });

      fetch('french_versatile_words.json')
        .then(response => response.json())
        .then(data => {
          FRENCH_VERSATILE_WORDS_DATA = data;
        });

      fetch('the_v_verbs.json')
        .then(response => response.json())
        .then(data => {
          THE_V_VERBS_DATA = data;
        });

      fetch('tefaq_vocab_final.json')
        .then(response => response.json())
        .then(data => {
          TEFAQ_VOCAB_FINAL_DATA = data;
        });

      fetch('phrases_for_learning.json')
        .then(response => response.json())
        .then(data => {
          PHRASES_FOR_LEARNING_DATA = data;
        });




        class FlashcardApp {
            constructor() {
                this.cards = [];
                this.shuffledCards = []; // New: shuffled deck for sequential navigation
                this.currentIndex = 0; // New: current position in shuffled deck
                this.currentCard = null; // Initialize currentCard
                this.correctCards = new Set();
                this.isFlipped = false;
                this.currentSide = 'french';
                this.cardHistory = [];
                this.historyIndex = -1;
                
                // Speech synthesis state
                this.isSpeaking = false;
                
                // Track which select was last used
                this.lastUsedSelect = 'desktop'; // 'desktop' or 'mobile'

                this.initializeElements();
                this.bindEvents();
                this.updateStats();
            }

            initializeElements() {
                this.fileSelect = document.getElementById('fileSelect');
                this.sideSelect = document.getElementById('sideSelect');
                this.flashcard = document.getElementById('flashcard');
                this.frontWord = document.getElementById('frontWord');
                this.frontExample = document.getElementById('frontExample');
                this.frontGrammarInfo = document.getElementById('frontGrammarInfo');
                this.backWord = document.getElementById('backWord');
                this.backExample = document.getElementById('backExample');
                this.backGrammarInfo = document.getElementById('backGrammarInfo');
                this.totalCardsEl = document.getElementById('totalCards');
                this.remainingCardsEl = document.getElementById('remainingCards');
                this.correctCardsEl = document.getElementById('correctCards');
                this.learnMoreLink = document.getElementById('learnMoreLink');
                this.speakBtn = document.getElementById('speakBtn');
                this.speakEnglishBtn = document.getElementById('speakEnglishBtn');
                this.forceStopBtn = document.getElementById('forceStopBtn');
                this.hideTextBtn = document.getElementById('hideTextBtn');
                this.showTextBtn = document.getElementById('showTextBtn');
                
                // Mobile elements
                this.hamburgerBtn = document.getElementById('hamburgerBtn');
                this.menuContent = document.getElementById('menuContent');
                this.fileSelectMobile = document.getElementById('fileSelectMobile');
                this.sideSelectMobile = document.getElementById('sideSelectMobile');
                this.resetScoreBtnMobile = document.getElementById('resetScoreBtnMobile');
                this.correctBtn = document.getElementById('correctBtn');
                this.incorrectBtn = document.getElementById('incorrectBtn');
                this.previousBtn = document.getElementById('previousBtn');
                this.nextBtn = document.getElementById('nextBtn');
            }

            bindEvents() {
                // Desktop events
                this.fileSelect.addEventListener('change', () => this.loadCards());
                this.sideSelect.addEventListener('change', () => {
                    this.lastUsedSelect = 'desktop';
                    this.updateCurrentSide();
                });
                this.flashcard.addEventListener('click', () => this.flipCard());
                this.speakBtn.addEventListener('click', () => this.speakText('french'));
                this.speakEnglishBtn.addEventListener('click', () => this.speakText('english'));
                this.forceStopBtn.addEventListener('click', () => this.forceStopSpeech());
                this.hideTextBtn.addEventListener('click', () => this.hideText());
                this.showTextBtn.addEventListener('click', () => this.showText());
                document.getElementById('resetScoreBtn').addEventListener('click', () => this.resetScore());
                
                // Mobile events
                this.hamburgerBtn.addEventListener('click', () => this.toggleHamburgerMenu());
                this.fileSelectMobile.addEventListener('change', () => this.loadCards());
                this.sideSelectMobile.addEventListener('change', () => {
                    this.lastUsedSelect = 'mobile';
                    this.updateCurrentSide();
                });
                this.resetScoreBtnMobile.addEventListener('click', () => this.resetScore());
                this.correctBtn.addEventListener('click', () => this.markAsCorrect());
                this.incorrectBtn.addEventListener('click', () => this.markAsIncorrect());
                this.previousBtn.addEventListener('click', () => this.showPreviousCard());
                this.nextBtn.addEventListener('click', () => this.showNextCard());
                
                // Keyboard events
                document.addEventListener('keydown', (e) => this.handleKeyPress(e));
                
                // Add click handlers for legend keys
                document.querySelectorAll('.legend-key').forEach(key => {
                    key.addEventListener('click', (e) => {
                        e.preventDefault();
                        const action = key.getAttribute('data-action');
                        this.handleLegendClick(action);
                    });
                });
                
                // Close hamburger menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.hamburgerBtn.contains(e.target) && !this.menuContent.contains(e.target)) {
                        this.menuContent.classList.remove('show');
                    }
                });
                
                // Save progress when page is about to unload
                window.addEventListener('beforeunload', () => this.saveProgress());
            }

            toggleHamburgerMenu() {
                this.menuContent.classList.toggle('show');
            }

            loadCards() {
                const selectedFile = this.fileSelect.value || this.fileSelectMobile.value;
                if (!selectedFile) return;

                // Sync both selects
                this.fileSelect.value = selectedFile;
                this.fileSelectMobile.value = selectedFile;

                // Load data from external JSON file
                fetch(selectedFile)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.cards = data;
                        // Randomize the deck at load time
                        this.shuffleDeck();
                        // Load saved progress from localStorage
                        this.loadProgress(selectedFile);
                    })
                    .catch(error => {
                        console.error('Error loading JSON file:', error);
                        this.showError('Error loading file. Please try again.');
                    });
            }

            shuffleDeck() {
                // Create a copy of the cards array and shuffle it
                this.shuffledCards = [...this.cards];
                for (let i = this.shuffledCards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.shuffledCards[i], this.shuffledCards[j]] = [this.shuffledCards[j], this.shuffledCards[i]];
                }
                this.currentIndex = 0;
            }

            updateCurrentSide() {
                // Get the value from the select that was just used
                const newSide = this.lastUsedSelect === 'mobile' 
                    ? this.sideSelectMobile.value 
                    : this.sideSelect.value;
                
                this.currentSide = newSide;
                
                // Sync both selects to the same value
                this.sideSelect.value = newSide;
                this.sideSelectMobile.value = newSide;
                
                console.log('Language setting changed to:', newSide, 'via', this.lastUsedSelect);
                
                if (this.currentCard !== null && this.currentCard !== undefined) {
                    this.displayCard();
                }
                this.saveProgress();
            }

            showNextCard() {
                if (this.currentIndex >= this.shuffledCards.length) {
                    this.showCompletionMessage();
                    return;
                }

                // Get the current card from the shuffled deck
                this.currentCard = this.currentIndex;
                this.isFlipped = false;
                this.flashcard.classList.remove('flipped');
                
                // Add to history
                this.cardHistory.push(this.currentCard);
                this.historyIndex = this.cardHistory.length - 1;
                
                this.displayCard();
                this.saveProgress();
            }

            showPreviousCard() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.currentCard = this.cardHistory[this.historyIndex];
                    this.isFlipped = false;
                    this.flashcard.classList.remove('flipped');
                    this.displayCard();
                    this.saveProgress();
                }
            }

            saveProgress() {
                const selectedFile = this.fileSelect.value;
                if (!selectedFile) return;

                const progress = {
                    shuffledCards: this.shuffledCards,
                    currentIndex: this.currentIndex,
                    correctCards: Array.from(this.correctCards),
                    cardHistory: this.cardHistory,
                    historyIndex: this.historyIndex,
                    currentCard: this.currentCard,
                    currentSide: this.currentSide,
                    timestamp: Date.now()
                };

                localStorage.setItem(`flashcard_progress_${selectedFile}`, JSON.stringify(progress));
            }

            loadProgress(selectedFile) {
                const savedProgress = localStorage.getItem(`flashcard_progress_${selectedFile}`);
                
                if (savedProgress) {
                    try {
                        const progress = JSON.parse(savedProgress);
                        
                        // Check if the saved data is still valid (same number of cards)
                        if (progress.shuffledCards && progress.shuffledCards.length === this.cards.length) {
                            this.shuffledCards = progress.shuffledCards;
                            this.currentIndex = progress.currentIndex || 0;
                            this.correctCards = new Set(progress.correctCards || []);
                            this.cardHistory = progress.cardHistory || [];
                            this.historyIndex = progress.historyIndex || -1;
                            this.currentCard = progress.currentCard;
                            this.currentSide = progress.currentSide || 'french';
                            
                            // Update the side selector to match saved preference
                            this.sideSelect.value = this.currentSide;
                            this.sideSelectMobile.value = this.currentSide;
                            
                            this.updateStats();
                            
                            // Show the current card if it exists, otherwise show next
                            if (this.currentCard !== null && this.currentCard !== undefined) {
                                this.displayCard();
                            } else {
                                this.showNextCard();
                            }
                            return;
                        }
                    } catch (error) {
                        console.error('Error loading progress:', error);
                    }
                }
                
                // If no valid saved progress, start fresh
                this.correctCards.clear();
                this.cardHistory = [];
                this.historyIndex = -1;
                this.currentIndex = 0;
                this.updateStats();
                this.showNextCard();
            }

            resetScore() {
                const selectedFile = this.fileSelect.value;
                if (!selectedFile) return;

                if (confirm('Are you sure you want to reset your progress for this category? This cannot be undone.')) {
                    // Clear localStorage for this category
                    localStorage.removeItem(`flashcard_progress_${selectedFile}`);
                    
                    // Reset current session
                    this.correctCards.clear();
                    this.shuffleDeck(); // Reshuffle the deck
                    this.cardHistory = [];
                    this.historyIndex = -1;
                    this.currentCard = null;
                    this.updateStats();
                    this.showNextCard();
                }
            }

            displayCard() {
                if (this.currentCard === null || this.currentCard === undefined) return;

                const card = this.shuffledCards[this.currentCard];
                if (!card) return;
                
                // Handle 2-element, 4-element, and 5-element arrays
                let frenchWord, englishWord, frenchExample, englishExample, grammarInfo;
                
                if (card.length === 5) {
                    [frenchWord, englishWord, frenchExample, englishExample, grammarInfo] = card;
                } else if (card.length === 4) {
                    [frenchWord, englishWord, frenchExample, englishExample] = card;
                    grammarInfo = null;
                } else if (card.length === 2) {
                    [frenchWord, englishWord] = card;
                    frenchExample = '';
                    englishExample = '';
                    grammarInfo = null;
                } else {
                    console.error('Invalid card format:', card);
                    return;
                }

                // Determine which side to show first
                let showFrenchFirst = this.currentSide === 'french' || 
                    (this.currentSide === 'random' && Math.random() < 0.5);

                if (showFrenchFirst) {
                    this.frontWord.textContent = frenchWord;
                    this.frontExample.textContent = frenchExample;
                    this.frontGrammarInfo.textContent = grammarInfo ? `(${grammarInfo})` : '';
                    this.backWord.textContent = englishWord;
                    this.backExample.textContent = englishExample;
                    this.backGrammarInfo.textContent = grammarInfo ? `(${grammarInfo})` : '';
                } else {
                    this.frontWord.textContent = englishWord;
                    this.frontExample.textContent = englishExample;
                    this.frontGrammarInfo.textContent = grammarInfo ? `(${grammarInfo})` : '';
                    this.backWord.textContent = frenchWord;
                    this.backExample.textContent = frenchExample;
                    this.backGrammarInfo.textContent = grammarInfo ? `(${grammarInfo})` : '';
                }

                // Update Learn More link
                this.updateLearnMoreLink(frenchWord);
            }

            flipCard() {
                this.isFlipped = !this.isFlipped;
                this.flashcard.classList.toggle('flipped', this.isFlipped);
            }

            markAsCorrect() {
                if (this.currentCard === null) return;
                
                // Mark the current card as correct
                this.correctCards.add(this.currentCard);
                
                // Advance to the next card
                this.currentIndex++;
                
                this.updateStats();
                this.saveProgress();
                this.showNextCard();
            }

            markAsIncorrect() {
                if (this.currentCard === null) return;
                
                // Move the incorrect card 5-10 positions down in the deck
                const moveDistance = Math.floor(Math.random() * 6) + 5; // Random 5-10 positions
                const newPosition = Math.min(this.currentIndex + moveDistance, this.shuffledCards.length - 1);
                
                // Remove the card from its current position
                const incorrectCard = this.shuffledCards.splice(this.currentIndex, 1)[0];
                
                // Insert it at the new position
                this.shuffledCards.splice(newPosition, 0, incorrectCard);
                
                // The current card at the current index is now a new card
                // No need to advance the index - just display the new card
                
                this.updateStats();
                this.saveProgress();
                this.displayCard();
            }

            handleKeyPress(event) {
                switch(event.key) {
                    case 'ArrowLeft':
                        event.preventDefault();
                        this.showPreviousCard();
                        break;
                    case 'ArrowRight':
                        event.preventDefault();
                        this.showNextCard();
                        break;
                    case ' ':
                        event.preventDefault();
                        this.flipCard();
                        break;
                    case 'a':
                    case 'A':
                        event.preventDefault();
                        this.markAsCorrect();
                        break;
                    case 'x':
                    case 'X':
                        event.preventDefault();
                        this.markAsIncorrect();
                        break;
                }
            }

            handleLegendClick(action) {
                switch(action) {
                    case 'previous':
                        this.showPreviousCard();
                        break;
                    case 'next':
                        this.showNextCard();
                        break;
                    case 'flip':
                        this.flipCard();
                        break;
                    case 'correct':
                        this.markAsCorrect();
                        break;
                    case 'incorrect':
                        this.markAsIncorrect();
                        break;
                }
            }

            updateStats() {
                this.totalCardsEl.textContent = this.cards.length;
                this.remainingCardsEl.textContent = this.cards.length - this.currentIndex;
                this.correctCardsEl.textContent = this.currentIndex;
            }

            showCompletionMessage() {
                this.frontWord.textContent = '🎉 Congratulations!';
                this.frontExample.textContent = `You've completed all ${this.cards.length} cards!`;
                this.frontGrammarInfo.textContent = '';
                this.backWord.textContent = '';
                this.backExample.textContent = '';
                this.backGrammarInfo.textContent = '';
                this.flashcard.classList.remove('flipped');
                
                // Hide Learn More link
                this.hideLearnMoreLink();
                
                // Add reset button
                const resetBtn = document.createElement('button');
                resetBtn.textContent = 'Start Over';
                resetBtn.className = 'reset-btn';
                resetBtn.style.marginTop = '20px';
                resetBtn.onclick = () => {
                    this.correctCards.clear();
                    this.shuffleDeck();
                    this.currentIndex = 0;
                    this.updateStats();
                    this.showNextCard();
                    resetBtn.remove();
                };
                
                const cardFront = this.flashcard.querySelector('.card-front');
                cardFront.appendChild(resetBtn);
            }

            showError(message) {
                this.frontWord.textContent = '❌ Error';
                this.frontExample.textContent = message;
                this.frontGrammarInfo.textContent = '';
                this.backWord.textContent = '';
                this.backExample.textContent = '';
                this.backGrammarInfo.textContent = '';
                
                // Hide Learn More link
                this.hideLearnMoreLink();
            }

            updateLearnMoreLink(frenchWord) {
                if (this.learnMoreLink) {
                    const searchQuery = encodeURIComponent(`meaning and use of "${frenchWord}" in French`);
                    this.learnMoreLink.href = `https://www.google.com/search?q=${searchQuery}`;
                    this.learnMoreLink.style.display = 'inline-block';
                }
            }

            hideLearnMoreLink() {
                if (this.learnMoreLink) {
                    this.learnMoreLink.style.display = 'none';
                }
            }

            removeParentheses(text) {
                if (!text) return text;
                // Remove text within parentheses, including the parentheses themselves
                return text.replace(/\([^)]*\)/g, '').trim();
            }

            checkAvailableVoices() {
                if (typeof responsiveVoice !== 'undefined') {
                    console.log('Available ResponsiveVoice voices:');
                    console.log(responsiveVoice.getVoices());
                    
                    // Also try to get voices using the standard Web Speech API for comparison
                    if ('speechSynthesis' in window) {
                        console.log('Web Speech API voices:');
                        const voices = window.speechSynthesis.getVoices();
                        console.log(voices.map(v => ({ name: v.name, lang: v.lang })));
                    }
                } else {
                    console.log('ResponsiveVoice not loaded');
                }
            }

            speakText(language = 'french') {
                if (this.currentCard === null) return;

                const card = this.shuffledCards[this.currentCard];
                let textToSpeak = '';
                let voice = '';
                let button = null;

                // Get the text based on language and card format
                if (language === 'french') {
                    button = this.speakBtn;
                    if (card.length === 5) {
                        // [frenchWord, englishWord, frenchExample, englishExample, grammarInfo]
                        textToSpeak = card[2] || card[0]; // Use French example if available, otherwise French word
                    } else if (card.length === 4) {
                        // [frenchWord, englishWord, frenchExample, englishExample]
                        textToSpeak = card[2] || card[0]; // Use French example if available, otherwise French word
                    } else if (card.length === 2) {
                        // [frenchPhrase, englishPhrase]
                        textToSpeak = card[0]; // Use French phrase
                    }
                    voice = 'French Female';
                } else if (language === 'english') {
                    button = this.speakEnglishBtn;
                    if (card.length === 5) {
                        // [frenchWord, englishWord, frenchExample, englishExample, grammarInfo]
                        textToSpeak = card[3] || card[1]; // Use English example if available, otherwise English word
                    } else if (card.length === 4) {
                        // [frenchWord, englishWord, frenchExample, englishExample]
                        textToSpeak = card[3] || card[1]; // Use English example if available, otherwise English word
                    } else if (card.length === 2) {
                        // [frenchPhrase, englishPhrase]
                        textToSpeak = card[1]; // Use English phrase
                    }
                    voice = 'UK English Female';
                }

                // Remove text within parentheses before speaking
                textToSpeak = this.removeParentheses(textToSpeak);

                // Debug logging
                console.log(`Speaking ${language}:`, textToSpeak);
                console.log('Voice:', voice);
                console.log('Button:', button);

                if (textToSpeak && typeof responsiveVoice !== 'undefined') {
                    // Check available voices for debugging
                    if (language === 'english') {
                        this.checkAvailableVoices();
                    }
                    this.speakWithResponsiveVoice(textToSpeak, voice, button, language);
                } else {
                    // Fallback for browsers without ResponsiveVoice
                    alert('Text-to-speech is not available. Please check your internet connection.');
                }
            }

            speakWithResponsiveVoice(textToSpeak, voice, button, language) {
                console.log('speakWithResponsiveVoice called with:', { textToSpeak, voice, language });
                
                // Disable the button while speaking and show force stop
                button.disabled = true;
                button.textContent = '🔊 Speaking...';
                this.forceStopBtn.style.display = 'inline-block';
                this.isSpeaking = true;

                // Configure ResponsiveVoice options
                const options = {
                    onstart: () => {
                        console.log('ResponsiveVoice speech started for', language);
                        console.log('Speech should be audible now');
                    },
                    onend: () => {
                        console.log('ResponsiveVoice speech ended for', language);
                        this.handleResponsiveVoiceEnd(button, language);
                    },
                    onerror: (error) => {
                        console.error('ResponsiveVoice error for', language, ':', error);
                        this.handleResponsiveVoiceError(button, language, error);
                    },
                    rate: 0.8,
                    pitch: 1.0,
                    volume: 1.0
                };

                // Speak the text
                try {
                    console.log('Calling responsiveVoice.speak with:', textToSpeak, voice, options);
                    responsiveVoice.speak(textToSpeak, voice, options);
                    
                    // For English, try using Web Speech API directly as fallback
                    /*
                    if (language === 'english') {
                        console.log('Trying Web Speech API directly for English');
                        this.speakWithWebSpeechAPI(textToSpeak, button, language);
                    } else {
                        responsiveVoice.speak(textToSpeak, voice, options);
                    }
                        */
                } catch (error) {
                    console.error('Error starting ResponsiveVoice:', error);
                    this.handleResponsiveVoiceError(button, language, error.message);
                }
            }

            speakWithWebSpeechAPI(textToSpeak, button, language) {
                console.log('Using Web Speech API for English:', textToSpeak);
                
                // Cancel any existing speech
                window.speechSynthesis.cancel();
                
                // Create utterance
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Set up event handlers
                utterance.onstart = () => {
                    console.log('Web Speech API started for English');
                };
                
                utterance.onend = () => {
                    console.log('Web Speech API ended for English');
                    this.handleResponsiveVoiceEnd(button, language);
                };
                
                utterance.onerror = (error) => {
                    console.error('Web Speech API error for English:', error);
                    this.handleResponsiveVoiceError(button, language, error.error);
                };
                
                // Speak
                try {
                    window.speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Error with Web Speech API:', error);
                    this.handleResponsiveVoiceError(button, language, error.message);
                }
            }

            handleResponsiveVoiceEnd(button, language) {
                // Re-enable button and hide force stop
                button.disabled = false;
                button.textContent = language === 'french' ? '🔊 Speak French' : '🔊 Speak English';
                this.forceStopBtn.style.display = 'none';
                this.isSpeaking = false;
            }

            handleResponsiveVoiceError(button, language, error) {
                console.error('ResponsiveVoice failed:', error);
                
                // Re-enable button and hide force stop
                button.disabled = false;
                button.textContent = language === 'french' ? '🔊 Speak French' : '🔊 Speak English';
                this.forceStopBtn.style.display = 'none';
                this.isSpeaking = false;

                // Show error message
                const originalText = button.textContent;
                button.textContent = '❌ Failed';
                button.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            }

            forceStopSpeech() {
                console.log('Force stopping ResponsiveVoice speech');
                
                // Stop ResponsiveVoice
                responsiveVoice.cancel();

                // Reset all speech buttons
                this.speakBtn.disabled = false;
                this.speakBtn.textContent = '🔊 Speak French';
                this.speakBtn.style.background = '';
                this.speakEnglishBtn.disabled = false;
                this.speakEnglishBtn.textContent = '🔊 Speak English';
                this.speakEnglishBtn.style.background = '';
                this.forceStopBtn.style.display = 'none';

                // Reset state
                this.isSpeaking = false;
            }

            hideText() {
                // Hide the flashcard content
                this.flashcard.style.display = 'none';
                // Show the show text button and hide the hide text button
                this.hideTextBtn.style.display = 'none';
                this.showTextBtn.style.display = 'inline-block';
            }

            showText() {
                // Show the flashcard content
                this.flashcard.style.display = 'block';
                // Show the hide text button and hide the show text button
                this.hideTextBtn.style.display = 'inline-block';
                this.showTextBtn.style.display = 'none';
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const app = new FlashcardApp();
            // Hide Learn More link initially
            app.hideLearnMoreLink();
            
            // Initialize select synchronization
            app.sideSelect.value = app.currentSide;
            app.sideSelectMobile.value = app.currentSide;
            
            // Check available voices after a short delay to ensure ResponsiveVoice is loaded
            setTimeout(() => {
                app.checkAvailableVoices();
            }, 1000);
        });
    </script>
</body>
</html>
